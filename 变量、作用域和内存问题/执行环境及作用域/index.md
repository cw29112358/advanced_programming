## 执行环境及作用域

执行环境定义了变量或函数有权访问的其他数据，决定他们各自的行为。每个执行环境都有一个与之相关联的变量对象，环境中定义的所有变量和函数都保存在这个对象中。

全局执行环境是最外围的一个执行环境。在web浏览器中，全局执行环境是 window 对象，因此，所有全局变量和函数都是作为 window 对象的属性和方法创建的。某个执行环境中的多有代码执行完毕后，该环境被销毁，保存在其中的所有变量和函数定义也随之销毁（全局执行环境直到应用程序退出才会被销毁）。

每个函数都有自己的执行环境。当执行流进入一个函数时，函数的环境就会被推入一个环境栈中，而在函数执行之后，栈将其环境弹出，把控制权返回给之前的执行环境。

当代码在一个环境中执行时，会创建变量对象的一个作用域链。作用域链的用途，是保证对执行环境有权访问的所有变量和函数的有序访问。作用域链的前端，始终都是当前执行的代码所在环境的变量对象。如果这个环境是函数，则将其活动对象作为变量对象。活动对象在最开始时值包含一个变量，即arguments对象（这个对象在全局环境中是不存在的）。作用域链的下一个变量对象来自包含（外部）环境，而在下一个变量对象则来自下一个包含环境。这样，一直延续到全局执行环境。全局执行环境的变量对象始终是作用域链中的最后一个对象。

标识符解析是沿着作用域链一级一级地搜索标识符地过程。搜索过程始终从作用域链的前端开始，然后逐级地向后回溯查询，如果在局部环境中找到了该标识符，搜索过程停止，变量就绪。如果在局部变量环境中没有找到该变量名，则继续沿着作用域链向上搜索，一直追溯到全局环境的变量对象。直到找到标识符为止，如果在全局环境中也没有找到这个标识符，则意味着该变量还未声明。

+ 延长作用域链

执行环境又两种类型：全局和局部（函数）。但是有些语句可以在作用域链地前端临时增加一个对象，该变量对象会在代码执行后被移除。

try-catch 语句地 catch 块；
with 语句；

```
function bindUrl() {
  var qs = '?debug=true'

  with (location) {
    var url = href + qs
  }

  return url
}
```

+ 没有块级作用域

```
if (true) {
  var color = 'blue'
}

alter(color) // 'blue'
```

```
for (var i = 0; i < 10; i++) {
  // ...
}

alter(i) // 10
```

使用 var 声明的变量会被自动添加到最近的环境中。在函数内部，最接近的环境是函数的局部环境；在 with 语句中，最接近的环境就是函数环境。如果初始化变量时没有使用 var 声明，该变量会自动添加到全局环境。